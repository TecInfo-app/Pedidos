<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Um cinza um pouco mais claro */
        }
        .modal-enter {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="p-4 bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="app-container" class="bg-white shadow-xl rounded-2xl p-6 w-full max-w-5xl mx-auto my-8">

        <div id="customer-page">
            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <div class="flex items-center justify-between gap-4 mb-4">
                    <a href="index.html" class="text-gray-500 hover:text-gray-800 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>
                    </a>
                    <div class="flex items-center justify-center flex-1">
                        <img id="restaurantLogo" src="#" alt="Logo do Restaurante" class="h-12 hidden mr-4">
                        <h1 class="text-3xl font-bold text-gray-800">Cardápio</h1>
                    </div>
                    <div class="relative">
                        <button id="openCartBtn" class="bg-white p-2 rounded-full shadow-lg text-gray-600 hover:text-gray-800 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                        </button>
                        <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">0</span>
                    </div>
                </div>
                <div id="restaurant-info-customer" class="text-center mt-4">
                    <h2 id="restaurant-name-customer" class="text-xl font-bold text-gray-800 mb-1 hidden"></h2>
                    <p id="restaurant-description-customer" class="text-gray-600 mb-2 hidden"></p>
                    <div id="contact-info-customer" class="text-sm text-gray-500 space-y-1">
                        <p id="restaurant-phone-customer" class="hidden">Telefone: <a href="#" class="hover:underline"></a></p>
                        <p id="restaurant-address-customer" class="hidden">Endereço: <span></span></p>
                        <p id="restaurant-email-customer" class="hidden">Email: <a href="#" class="hover:underline"></a></p>
                        <p id="restaurant-hours-customer" class="hidden">Horário: <span></span></p>
                    </div>
                </div>
            </div>

            <div id="customerProductList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="text-center text-gray-500" id="loadingIndicatorCustomer">Carregando cardápio...</div>
            </div>
        </div>

        <div id="messageBox" class="fixed bottom-4 right-4 p-4 text-white rounded-lg shadow-lg z-50 hidden transition-all duration-300"></div>
    </div>

    <div id="product-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl modal-enter">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h3 id="modal-product-name" class="text-2xl font-bold text-gray-800"></h3>
                <button id="closeProductDetailModalBtn" class="text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="max-h-[60vh] overflow-y-auto mb-4 p-2 -mx-2">
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <img id="modal-product-image" src="#" alt="Produto" class="w-full md:w-1/3 h-48 object-cover rounded-xl border border-gray-200">
                    <div class="flex-1">
                        <p id="modal-product-description" class="text-gray-600 mb-2"></p>
                        <p class="text-2xl font-bold text-green-600">Preço: <span id="modal-product-price">R$ 0,00</span></p>
                    </div>
                </div>
                <div id="modal-complements-list" class="space-y-6">
                    </div>
            </div>
            <div class="mt-4 pt-4 border-t flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <button id="quantity-minus" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-full hover:bg-gray-300">-</button>
                    <span id="quantity-display" class="text-xl font-bold">1</span>
                    <button id="quantity-plus" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-full hover:bg-gray-300">+</button>
                </div>
                <button id="addToCartBtn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700">Adicionar ao Carrinho</button>
            </div>
        </div>
    </div>

    <div id="cart-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl modal-enter">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h3 class="text-2xl font-bold text-gray-800">Seu Carrinho</h3>
                <button id="closeCartModalBtn" class="text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div id="cart-items-list" class="max-h-[60vh] overflow-y-auto mb-4 p-2 -mx-2 space-y-4">
                </div>
            <div id="cart-summary" class="mt-4 pt-4 border-t flex justify-between items-center text-xl font-bold">
                <span>Total:</span>
                <span id="cart-total-price">R$ 0,00</span>
            </div>
            <button id="checkoutBtn" class="mt-4 w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-green-700">Finalizar Pedido (Simulação)</button>
        </div>
    </div>
    
    <div id="customer-info-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-lg modal-enter">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h3 class="text-2xl font-bold text-gray-800">Seus Dados</h3>
                <button id="closeCustomerInfoModalBtn" class="text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="customerName" class="block text-sm font-medium text-gray-700">Nome completo</label>
                    <input type="text" id="customerName" placeholder="Seu nome" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label for="customerPhone" class="block text-sm font-medium text-gray-700">Telefone (Whatsapp)</label>
                    <input type="tel" id="customerPhone" placeholder="(99) 99999-9999" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label for="customerEmail" class="block text-sm font-medium text-gray-700">Email (Opcional)</label>
                    <input type="email" id="customerEmail" placeholder="seu-email@exemplo.com" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label for="customerCep" class="block text-sm font-medium text-gray-700">CEP</label>
                    <input type="text" id="customerCep" placeholder="00000-000" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label for="customerAddress" class="block text-sm font-medium text-gray-700">Endereço</label>
                    <input type="text" id="customerAddress" placeholder="Rua, Bairro, Cidade" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="customerNumber" class="block text-sm font-medium text-gray-700">Número</label>
                        <input type="text" id="customerNumber" placeholder="Ex: 123" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <label for="customerComplement" class="block text-sm font-medium text-gray-700">Complemento (Opcional)</label>
                        <input type="text" id="customerComplement" placeholder="Ex: Apto 101" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                </div>
                <div>
                    <label for="customerReference" class="block text-sm font-medium text-gray-700">Ponto de Referência (Opcional)</label>
                    <textarea id="customerReference" placeholder="Ex: Próximo à padaria" rows="2" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-between gap-4">
                <button id="backToCartBtn" class="w-1/3 bg-gray-300 text-gray-800 font-bold py-3 rounded-lg shadow-md hover:bg-gray-400">Voltar</button>
                <button id="continueToPaymentBtn" class="w-2/3 bg-green-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-green-700">Continuar</button>
            </div>
        </div>
    </div>
    
    <div id="payment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm modal-enter">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h3 class="text-2xl font-bold text-gray-800">Finalizar Pagamento</h3>
                <button id="closePaymentModalBtn" class="text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="space-y-4">
                <p class="text-lg font-medium text-gray-700">Total do Pedido:</p>
                <p class="text-4xl font-extrabold text-green-600" id="payment-total-price">R$ 0,00</p>
                <h4 class="text-xl font-bold text-gray-800 mt-6">Escolha a forma de pagamento:</h4>
                <div class="grid grid-cols-1 gap-2">
                    <button class="payment-option-btn bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300" data-payment="Cartão">Cartão</button>
                    <button class="payment-option-btn bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300" data-payment="Dinheiro">Dinheiro</button>
                    <button class="payment-option-btn bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300" data-payment="Pix">Pix</button>
                </div>
            </div>
            <button id="confirmOrderBtn" class="mt-6 w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Confirmar Pedido</button>
        </div>
    </div>


    <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm modal-enter">
            <h3 id="confirmationModalTitle" class="text-xl font-bold text-gray-800 mb-4">Confirmação</h3>
            <p id="confirmationModalMessage" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-2">
                <button id="cancelConfirmationBtn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-400">Cancelar</button>
                <button id="confirmActionBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // ======================= ESTADO GLOBAL E VARIÁVEIS =======================
        let allProducts = [];
        let allCategories = [];
        let productComplementsCache = {};
        let cart = [];
        let myOrders = [];
        let restaurantProfile = {};
        let selectedProductForCart = null;
        let selectedComplements = {};
        let currentQuantity = 1;
        let confirmationCallback = null;
        
        // NOVO: Armazena dados do cliente e pagamento
        let customerInfo = {};
        let selectedPaymentMethod = null;
        let totalCartPrice = 0;


        // ======================= REFERÊNCIAS AOS ELEMENTOS DO DOM =======================
        // Elementos do Cardápio (Cliente)
        const openCartBtn = document.getElementById('openCartBtn');
        const cartCount = document.getElementById('cart-count');
        const customerProductList = document.getElementById('customerProductList');
        const loadingIndicatorCustomer = document.getElementById('loadingIndicatorCustomer');
        const messageBox = document.getElementById('messageBox');

        // Modais de Cliente
        const productDetailModal = document.getElementById('product-detail-modal');
        const modalProductName = document.getElementById('modal-product-name');
        const modalProductImage = document.getElementById('modal-product-image');
        const modalProductDescription = document.getElementById('modal-product-description');
        const modalProductPrice = document.getElementById('modal-product-price');
        const modalComplementsList = document.getElementById('modal-complements-list');
        const quantityMinusBtn = document.getElementById('quantity-minus');
        const quantityDisplay = document.getElementById('quantity-display');
        const quantityPlusBtn = document.getElementById('quantity-plus');
        const addToCartBtn = document.getElementById('addToCartBtn');
        const closeProductDetailModalBtn = document.getElementById('closeProductDetailModalBtn');
        const cartModal = document.getElementById('cart-modal');
        const cartItemsList = document.getElementById('cart-items-list');
        const cartTotalPrice = document.getElementById('cart-total-price');
        // ATUALIZADO: Botão do carrinho agora tem a função de continuar
        const checkoutBtn = document.getElementById('checkoutBtn');
        checkoutBtn.textContent = 'Continuar'; // Atualiza o texto do botão
        const closeCartModalBtn = document.getElementById('closeCartModalBtn');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationModalTitle = document.getElementById('confirmationModalTitle');
        const confirmationModalMessage = document.getElementById('confirmationModalMessage');
        const cancelConfirmationBtn = document.getElementById('cancelConfirmationBtn');
        const confirmActionBtn = document.getElementById('confirmActionBtn');

        // NOVO: Elementos do modal de dados do cliente
        const customerInfoModal = document.getElementById('customer-info-modal');
        const closeCustomerInfoModalBtn = document.getElementById('closeCustomerInfoModalBtn');
        const backToCartBtn = document.getElementById('backToCartBtn');
        const continueToPaymentBtn = document.getElementById('continueToPaymentBtn');
        const customerNameInput = document.getElementById('customerName');
        const customerPhoneInput = document.getElementById('customerPhone');
        const customerEmailInput = document.getElementById('customerEmail');
        const customerCepInput = document.getElementById('customerCep');
        const customerAddressInput = document.getElementById('customerAddress');
        const customerNumberInput = document.getElementById('customerNumber');
        const customerComplementInput = document.getElementById('customerComplement');
        const customerReferenceInput = document.getElementById('customerReference');
        
        // NOVO: Elementos do modal de pagamento
        const paymentModal = document.getElementById('payment-modal');
        const closePaymentModalBtn = document.getElementById('closePaymentModalBtn');
        const paymentTotalPrice = document.getElementById('payment-total-price');
        const paymentOptionBtns = document.querySelectorAll('.payment-option-btn');
        const confirmOrderBtn = document.getElementById('confirmOrderBtn');


        // Elementos de exibição do perfil na página do cliente
        const restaurantLogoCustomer = document.getElementById('restaurantLogo');
        const restaurantNameCustomer = document.getElementById('restaurant-name-customer');
        const restaurantDescriptionCustomer = document.getElementById('restaurant-description-customer');
        const restaurantPhoneCustomer = document.getElementById('restaurant-phone-customer');
        const restaurantAddressCustomer = document.getElementById('restaurant-address-customer');
        const restaurantEmailCustomer = document.getElementById('restaurant-email-customer');
        const restaurantHoursCustomer = document.getElementById('restaurant-hours-customer');

        // ======================= FUNÇÕES AUXILIARES =======================
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-yellow-500');
            if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.add('bg-yellow-500');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        function toggleModal(modal, show) {
            if (show) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        // ======================= PERSISTÊNCIA DE DADOS COM LOCALSTORAGE =======================
        function saveToLocalStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function loadFromLocalStorage(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        function loadAllClientData() {
            allCategories = loadFromLocalStorage('allCategories');
            allProducts = loadFromLocalStorage('allProducts');
            productComplementsCache = JSON.parse(localStorage.getItem('productComplementsCache')) || {};
            cart = loadFromLocalStorage('cart');
            myOrders = loadFromLocalStorage('myOrders');
            restaurantProfile = JSON.parse(localStorage.getItem('restaurantProfile')) || {};
            
            renderRestaurantInfo();
            renderCustomerProductList();
            updateCartCount();
            loadingIndicatorCustomer.classList.add('hidden');
        }
        
        function renderRestaurantInfo() {
            if (restaurantProfile.logo) {
                restaurantLogoCustomer.src = restaurantProfile.logo;
                restaurantLogoCustomer.classList.remove('hidden');
            } else {
                restaurantLogoCustomer.classList.add('hidden');
            }
            
            if (restaurantProfile.show?.name && restaurantProfile.name) {
                restaurantNameCustomer.textContent = restaurantProfile.name;
                restaurantNameCustomer.classList.remove('hidden');
            } else {
                restaurantNameCustomer.classList.add('hidden');
            }
            
            if (restaurantProfile.show?.description && restaurantProfile.description) {
                restaurantDescriptionCustomer.textContent = restaurantProfile.description;
                restaurantDescriptionCustomer.classList.remove('hidden');
            } else {
                restaurantDescriptionCustomer.classList.add('hidden');
            }

            if (restaurantProfile.show?.phone && restaurantProfile.phone) {
                restaurantPhoneCustomer.querySelector('a').textContent = restaurantProfile.phone;
                restaurantPhoneCustomer.querySelector('a').href = `tel:${restaurantProfile.phone.replace(/\D/g, '')}`;
                restaurantPhoneCustomer.classList.remove('hidden');
            } else {
                restaurantPhoneCustomer.classList.add('hidden');
            }

            if (restaurantProfile.show?.address && restaurantProfile.address) {
                restaurantAddressCustomer.querySelector('span').textContent = restaurantProfile.address;
                restaurantAddressCustomer.classList.remove('hidden');
            } else {
                restaurantAddressCustomer.classList.add('hidden');
            }

            if (restaurantProfile.show?.email && restaurantProfile.email) {
                restaurantEmailCustomer.querySelector('a').textContent = restaurantProfile.email;
                restaurantEmailCustomer.querySelector('a').href = `mailto:${restaurantProfile.email}`;
                restaurantEmailCustomer.classList.remove('hidden');
            } else {
                restaurantEmailCustomer.classList.add('hidden');
            }

            if (restaurantProfile.show?.hours && restaurantProfile.hours) {
                restaurantHoursCustomer.querySelector('span').textContent = restaurantProfile.hours;
                restaurantHoursCustomer.classList.remove('hidden');
            } else {
                restaurantHoursCustomer.classList.add('hidden');
            }
        }


        // ======================= FUNÇÕES DA PÁGINA DO CLIENTE =======================
        function renderCustomerProductList() {
            customerProductList.innerHTML = '';
            const activeProducts = allProducts.filter(p => !p.paused);

            if (activeProducts.length === 0) {
                customerProductList.innerHTML = '<div class="text-center text-gray-500 col-span-full">Nenhum item disponível no cardápio.</div>';
                return;
            }

            const productsByCategory = activeProducts.reduce((acc, product) => {
                const category = allCategories.find(c => c.id === product.categoryId) || { name: 'Sem Categoria', id: 'uncategorized' };
                if (!acc[category.name]) {
                    acc[category.name] = { id: category.id, products: [] };
                }
                acc[category.name].products.push(product);
                return acc;
            }, {});

            for (const categoryName in productsByCategory) {
                const categorySection = document.createElement('div');
                categorySection.className = 'col-span-full mb-4 mt-6';
                categorySection.innerHTML = `<h2 class="text-2xl font-bold text-gray-800">${categoryName}</h2>`;
                customerProductList.appendChild(categorySection);

                productsByCategory[categoryName].products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'bg-white rounded-xl shadow-md p-4 flex flex-col product-card cursor-pointer';
                    productCard.dataset.id = product.id;
                    productCard.innerHTML = `
                        <img src="${product.image}" alt="${product.name}" class="w-full h-40 object-cover rounded-lg mb-4">
                        <h3 class="text-lg font-bold text-gray-800">${product.name}</h3>
                        ${product.pdvCode ? `<p class="text-xs text-gray-400">Cód.: ${product.pdvCode}</p>` : ''}
                        <p class="text-sm text-gray-500 flex-1">${product.description || 'Sem descrição.'}</p>
                        <p class="text-xl font-bold text-green-600 mt-2">R$ ${product.price.toFixed(2).replace('.', ',')}</p>
                        <button data-id="${product.id}" class="add-to-cart-simple mt-4 bg-green-500 text-white font-bold py-2 rounded-lg shadow-md hover:bg-green-600 transition-colors">
                            Adicionar
                        </button>
                    `;
                    customerProductList.appendChild(productCard);
                });
            }
        }

        function openProductDetailModal(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product || product.paused) return;
            
            selectedProductForCart = product;
            selectedComplements = {};
            currentQuantity = 1;

            modalProductName.textContent = product.name;
            modalProductImage.src = product.image;
            modalProductDescription.textContent = product.description || 'Sem descrição.';
            modalProductPrice.textContent = `R$ ${product.price.toFixed(2).replace('.', ',')}`;
            quantityDisplay.textContent = currentQuantity;
            
            renderComplementsForClient(productId);
            toggleModal(productDetailModal, true);
        }

        function renderComplementsForClient(productId) {
            modalComplementsList.innerHTML = '';
            const complements = (productComplementsCache[productId] || []).filter(g => !g.paused);
            
            if (complements.length === 0) {
                modalComplementsList.innerHTML = '<p class="text-gray-500 text-center">Nenhum complemento disponível para este produto.</p>';
                updateCartPrice();
                return;
            }

            complements.forEach((group, groupIndex) => {
                const activeOptions = group.options.filter(o => !o.paused);
                if (activeOptions.length === 0) return;

                const groupDiv = document.createElement('div');
                groupDiv.className = 'p-4 bg-gray-100 rounded-lg';
                groupDiv.innerHTML = `
                    <h4 class="text-xl font-bold text-gray-800">${group.name}</h4>
                    <p class="text-sm text-gray-500 mb-2">${group.description || ''}</p>
                    ${group.isMandatory ? `<p class="text-xs text-red-500 mb-2">Obrigatório. Escolha entre ${group.minSelection} e ${group.maxSelection} opções.</p>` : ''}
                    <div id="options-for-group-${groupIndex}" class="space-y-2 mt-2">
                    </div>
                `;
                modalComplementsList.appendChild(groupDiv);

                const optionsContainer = document.getElementById(`options-for-group-${groupIndex}`);
                activeOptions.forEach(option => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200';
                    const inputType = (group.maxSelection === 1) ? 'radio' : 'checkbox';
                    const inputName = `complement-group-${groupIndex}`;
                    optionDiv.innerHTML = `
                        <label class="flex items-center flex-1 cursor-pointer">
                            <input type="${inputType}" name="${inputName}" data-group-index="${groupIndex}" data-option-id="${option.name}" data-price="${option.price}" class="complement-option-input h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                            <span class="ml-3 text-gray-700 font-medium">${option.name}</span>
                        </label>
                        <span class="text-green-600 font-semibold">+ R$ ${option.price.toFixed(2).replace('.', ',')})</span>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
            });
            updateCartPrice();
        }

        function updateCartPrice() {
            if (!selectedProductForCart) return;
            let totalComplementPrice = 0;
            for (const groupIndex in selectedComplements) {
                totalComplementPrice += selectedComplements[groupIndex].reduce((sum, opt) => sum + opt.price, 0);
            }
            const totalItemPrice = (selectedProductForCart.price + totalComplementPrice) * currentQuantity;
            modalProductPrice.textContent = `R$ ${totalItemPrice.toFixed(2).replace('.', ',')}`;
            addToCartBtn.textContent = `Adicionar (R$ ${totalItemPrice.toFixed(2).replace('.', ',')})`;
        }

        // ======================= FUNÇÕES DO CARRINHO =======================
        function addToCart() {
            const complementsConfig = productComplementsCache[selectedProductForCart.id] || [];
            let isValid = true;
            let totalComplementPrice = 0;
            const itemComplements = {};

            // Mapeia os complementos selecionados para a estrutura do carrinho
            for (const groupIndex in selectedComplements) {
                const groupConfig = complementsConfig[groupIndex];
                if (!groupConfig) continue;

                if (groupConfig.isMandatory) {
                    const selectedCount = selectedComplements[groupIndex].length;
                    if (selectedCount < groupConfig.minSelection || selectedCount > groupConfig.maxSelection) {
                        showMessage(`Obrigatório: Selecione entre ${groupConfig.minSelection} e ${groupConfig.maxSelection} opções para "${groupConfig.name}".`, 'error');
                        isValid = false;
                        break;
                    }
                }
                
                itemComplements[groupConfig.name] = selectedComplements[groupIndex];
                totalComplementPrice += selectedComplements[groupIndex].reduce((sum, opt) => sum + opt.price, 0);
            }
            if (!isValid) return;

            const basePrice = selectedProductForCart.price;
            const finalPrice = (basePrice + totalComplementPrice) * currentQuantity;

            const cartItem = {
                product: selectedProductForCart,
                quantity: currentQuantity,
                complements: itemComplements,
                totalPrice: finalPrice
            };
            cart.push(cartItem);
            saveToLocalStorage('cart', cart);
            updateCartCount();
            toggleModal(productDetailModal, false);
            showMessage('Produto adicionado ao carrinho!', 'success');
        }

        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
            if (totalItems > 0) {
                cartCount.classList.remove('hidden');
            } else {
                cartCount.classList.add('hidden');
            }
        }

        function openCartModal() {
            renderCartItems();
            toggleModal(cartModal, true);
        }

        function renderCartItems() {
            cartItemsList.innerHTML = '';
            totalCartPrice = 0;
            if (cart.length === 0) {
                cartItemsList.innerHTML = '<p class="text-center text-gray-500">Seu carrinho está vazio.</p>';
            } else {
                cart.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'bg-white p-4 rounded-lg shadow-sm flex gap-4 items-center border border-gray-200';
                    let complementsHtml = '';
                    if (item.complements) {
                        for (const groupName in item.complements) {
                            complementsHtml += `<p class="text-sm font-bold text-gray-600 mt-2">${groupName}:</p>`;
                            complementsHtml += `<ul class="list-disc pl-5 text-xs text-gray-500">`;
                            complementsHtml += item.complements[groupName].map(c => 
                                `<li>${c.name} ${c.price > 0 ? `(+R$ ${c.price.toFixed(2).replace('.', ',')})` : ''}</li>`
                            ).join('');
                            complementsHtml += `</ul>`;
                        }
                    }

                    itemDiv.innerHTML = `
                        <img src="${item.product.image}" alt="${item.product.name}" class="w-16 h-16 object-cover rounded-md">
                        <div class="flex-1">
                            <h4 class="text-lg font-bold text-gray-800">${item.product.name}</h4>
                            ${complementsHtml}
                            <p class="text-lg font-semibold text-green-600 mt-2">Total: R$ ${item.totalPrice.toFixed(2).replace('.', ',')}</p>
                        </div>
                        <div class="flex flex-col items-center gap-2">
                            <div class="flex items-center gap-2">
                                <button data-index="${index}" class="update-quantity-btn bg-gray-200 text-gray-700 font-bold w-6 h-6 rounded-full">-</button>
                                <span class="text-lg font-bold">${item.quantity}</span>
                                <button data-index="${index}" class="update-quantity-btn bg-gray-200 text-gray-700 font-bold w-6 h-6 rounded-full">+</button>
                            </div>
                            <button data-index="${index}" class="remove-cart-item-btn text-red-500 text-sm hover:text-red-700 transition-colors">Remover</button>
                        </div>
                    `;
                    cartItemsList.appendChild(itemDiv);
                    totalCartPrice += item.totalPrice;
                });
            }
            cartTotalPrice.textContent = `R$ ${totalCartPrice.toFixed(2).replace('.', ',')}`;
        }

        function updateCartItemQuantity(index, increment) {
            const item = cart[index];
            if (!item) return;

            item.quantity += increment;
            if (item.quantity <= 0) {
                cart.splice(index, 1);
            } else {
                let basePrice = item.product.price;
                let complementPrice = 0;
                for (const groupName in item.complements) {
                    complementPrice += item.complements[groupName].reduce((sum, opt) => sum + opt.price, 0);
                }
                item.totalPrice = (basePrice + complementPrice) * item.quantity;
            }

            saveToLocalStorage('cart', cart);
            renderCartItems();
            updateCartCount();
        }

        function removeCartItem(index) {
            cart.splice(index, 1);
            saveToLocalStorage('cart', cart);
            renderCartItems();
            updateCartCount();
        }
        
        // NOVO: Função para abrir o modal de dados do cliente
        function openCustomerInfoModal() {
            if (cart.length === 0) {
                showMessage('Seu carrinho está vazio!', 'error');
                return;
            }
            toggleModal(cartModal, false);
            toggleModal(customerInfoModal, true);
        }
        
        // NOVO: Função para abrir o modal de pagamento
        function openPaymentModal() {
            const name = customerNameInput.value.trim();
            const phone = customerPhoneInput.value.trim();
            const cep = customerCepInput.value.trim();
            const address = customerAddressInput.value.trim();
            const number = customerNumberInput.value.trim();

            if (!name || !phone || !cep || !address || !number) {
                showMessage('Por favor, preencha nome, telefone, CEP, endereço e número.', 'error');
                return;
            }
            
            customerInfo = {
                name,
                phone,
                email: customerEmailInput.value.trim(),
                cep,
                address,
                number,
                complement: customerComplementInput.value.trim(),
                reference: customerReferenceInput.value.trim()
            };

            paymentTotalPrice.textContent = `R$ ${totalCartPrice.toFixed(2).replace('.', ',')}`;
            selectedPaymentMethod = null;
            confirmOrderBtn.disabled = true;
            paymentOptionBtns.forEach(btn => btn.classList.remove('bg-green-500', 'text-white'));
            
            toggleModal(customerInfoModal, false);
            toggleModal(paymentModal, true);
        }
        
        // NOVO: Função para finalizar o pedido
        function finalizeOrder() {
            if (!selectedPaymentMethod) {
                showMessage('Por favor, selecione uma forma de pagamento.', 'error');
                return;
            }

            const clientData = {
                name: customerInfo.name,
                phone: customerInfo.phone,
                address: `${customerInfo.address}, Nº ${customerInfo.number} - ${customerInfo.complement ? `(${customerInfo.complement})` : ''}`,
                cep: customerInfo.cep,
                email: customerInfo.email
            };
            
            // Gerar um ID de cliente único (opcional, mas recomendado)
            const clientId = customerInfo.phone.replace(/\D/g, ''); // Usa o telefone como ID único
            
            // Salva ou atualiza o cliente no localStorage
            let clients = JSON.parse(localStorage.getItem('clients')) || {};
            clients[clientId] = clientData;
            localStorage.setItem('clients', JSON.stringify(clients));
            
            const order = {
                id: Date.now().toString(),
                date: new Date().toLocaleDateString('pt-BR'),
                customer: customerInfo,
                paymentMethod: selectedPaymentMethod,
                total: totalCartPrice,
                items: [...cart]
            };
            myOrders.push(order);
            saveToLocalStorage('myOrders', myOrders);

            cart = [];
            saveToLocalStorage('cart', cart);
            updateCartCount();
            toggleModal(paymentModal, false);
            showMessage('Pedido finalizado com sucesso!', 'success');
        }
        
        // Modal de Confirmação Genérico
        function showConfirmationModal(title, message, callback) {
            confirmationModalTitle.textContent = title;
            confirmationModalMessage.textContent = message;
            confirmationCallback = callback;
            toggleModal(confirmationModal, true);
        }

        // ======================= FUNÇÃO DE BUSCA DE CEP =======================
        async function searchAddressByCep() {
            let cep = customerCepInput.value.replace(/\D/g, '');

            if (cep.length !== 8) {
                return;
            }

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();

                if (!data.erro) {
                    customerAddressInput.value = `${data.logradouro}, ${data.bairro}, ${data.localidade} - ${data.uf}`;
                } else {
                    showMessage('CEP não encontrado.', 'error');
                    customerAddressInput.value = '';
                }
            } catch (error) {
                showMessage('Erro ao buscar CEP.', 'error');
            }
        }
        
        // ======================= LISTENERS DE EVENTOS =======================
        window.addEventListener('DOMContentLoaded', loadAllClientData);

        customerProductList.addEventListener('click', (e) => {
            const productCard = e.target.closest('.product-card');
            const simpleAddBtn = e.target.closest('.add-to-cart-simple');

            if (productCard && !simpleAddBtn) {
                const id = productCard.dataset.id;
                openProductDetailModal(id);
            } else if (simpleAddBtn) {
                const productId = simpleAddBtn.dataset.id;
                const product = allProducts.find(p => p.id === productId);
                if (product) {
                    const complements = (productComplementsCache[productId] || []).filter(g => !g.paused);
                    if (complements.length > 0) {
                         openProductDetailModal(productId);
                    } else {
                        cart.push({
                            product: product,
                            quantity: 1,
                            complements: {},
                            totalPrice: product.price
                        });
                        saveToLocalStorage('cart', cart);
                        updateCartCount();
                        showMessage('Produto adicionado ao carrinho!', 'success');
                    }
                }
            }
        });

        closeProductDetailModalBtn.addEventListener('click', () => toggleModal(productDetailModal, false));
        quantityMinusBtn.addEventListener('click', () => {
            if (currentQuantity > 1) {
                currentQuantity--;
                quantityDisplay.textContent = currentQuantity;
                updateCartPrice();
            }
        });
        quantityPlusBtn.addEventListener('click', () => {
            currentQuantity++;
            quantityDisplay.textContent = currentQuantity;
            updateCartPrice();
        });
        
        modalComplementsList.addEventListener('change', (e) => {
            if (e.target.classList.contains('complement-option-input')) {
                const input = e.target;
                const groupIndex = parseInt(input.dataset.group-index);
                const optionId = input.dataset.option-id;
                const price = parseFloat(input.dataset.price);

                const group = productComplementsCache[selectedProductForCart.id][groupIndex];
                if (!selectedComplements[groupIndex]) {
                    selectedComplements[groupIndex] = [];
                }

                if (input.type === 'radio') {
                    selectedComplements[groupIndex] = [];
                    selectedComplements[groupIndex].push({ name: optionId, price });
                } else if (input.type === 'checkbox') {
                    const selectedCount = selectedComplements[groupIndex].length;
                    if (group.maxSelection > 0 && selectedCount >= group.maxSelection) {
                        showMessage(`O limite de ${group.maxSelection} opções para "${group.name}" foi atingido.`, 'error');
                        input.checked = false;
                    } else {
                        selectedComplements[groupIndex].push({ name: optionId, price });
                    }
                } else {
                    selectedComplements[groupIndex] = selectedComplements[groupIndex].filter(opt => opt.name !== optionId);
                }
                updateCartPrice();
            }
        });
        
        addToCartBtn.addEventListener('click', addToCart);

        openCartBtn.addEventListener('click', openCartModal);
        closeCartModalBtn.addEventListener('click', () => toggleModal(cartModal, false));
        // ATUALIZADO: Evento do botão "Continuar" no carrinho
        checkoutBtn.addEventListener('click', openCustomerInfoModal);

        cartItemsList.addEventListener('click', (e) => {
            const updateBtn = e.target.closest('.update-quantity-btn');
            const removeBtn = e.target.closest('.remove-cart-item-btn');
            if (updateBtn) {
                const index = parseInt(updateBtn.dataset.index);
                const increment = updateBtn.textContent === '+' ? 1 : -1;
                updateCartItemQuantity(index, increment);
            } else if (removeBtn) {
                const index = parseInt(removeBtn.dataset.index);
                showConfirmationModal('Remover Item', 'Tem certeza que deseja remover este item do carrinho?', () => removeCartItem(index));
            }
        });

        // NOVO: Listeners para o modal de dados do cliente
        closeCustomerInfoModalBtn.addEventListener('click', () => toggleModal(customerInfoModal, false));
        backToCartBtn.addEventListener('click', () => {
            toggleModal(customerInfoModal, false);
            toggleModal(cartModal, true);
        });
        continueToPaymentBtn.addEventListener('click', openPaymentModal);
        
        // NOVO: Listener para o campo de CEP
        customerCepInput.addEventListener('blur', searchAddressByCep);


        // NOVO: Listeners para o modal de pagamento
        closePaymentModalBtn.addEventListener('click', () => toggleModal(paymentModal, false));
        confirmOrderBtn.addEventListener('click', finalizeOrder);
        paymentOptionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                paymentOptionBtns.forEach(b => b.classList.remove('bg-green-500', 'text-white'));
                btn.classList.add('bg-green-500', 'text-white');
                selectedPaymentMethod = btn.dataset.payment;
                confirmOrderBtn.disabled = false;
            });
        });

        cancelConfirmationBtn.addEventListener('click', () => toggleModal(confirmationModal, false));
        confirmActionBtn.addEventListener('click', () => {
            if (confirmationCallback) {
                confirmationCallback();
            }
            confirmationCallback = null;
            toggleModal(confirmationModal, false);
        });

    </script>
</body>
</html>